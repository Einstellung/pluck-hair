# 燕窝挑毛系统 - 架构决策记录

## 文档说明
本文档记录燕窝挑毛系统的核心架构决策和设计思路，作为后续详细设计和开发的基础。

**最后更新：** 2025-10-25

---

## 1. 项目概述

### 1.1 业务目标
使用3台协作机械臂完成燕窝挑毛任务：
- **压板臂**：压住燕窝固定工作区域
- **视觉臂**：搭载相机，识别托盘和异物
- **夹取臂**：搭载夹爪，夹取异物

### 1.2 核心流程
1. 托盘定位（边缘扫描确定坐标系）
2. 区域扫描（分区逐个处理，每区约3×3cm）
3. 异物识别（深度学习检测毛发、黑点、黄点）
4. IBVS伺服（视觉引导夹爪精确对准异物）
5. 夹取清洗（夹取后清洗夹爪）
6. 区域复检（确认清洁后移至下一区域）

---

## 2. 核心架构决策

### 决策1：控制方式 - PLC主导 + ROS 2服务提供
**决策：** PLC运行三臂协同状态机，ROS 2作为智能服务提供者（大脑）

**理由：**
- PLC擅长实时运动协调和多臂同步
- ROS 2专注视觉智能和复杂计算
- 职责清晰：PLC是"指挥官"，ROS 2是"大脑"

**架构关系：**
```
PLC (执行协调层)              ROS 2 (智能决策层)
─────────────────            ─────────────────────
• 三臂运动协调                • 状态管理（响应式）
• 物理执行                    • 视觉处理（AI推理）
• 到位检测                    • 运动计算（IBVS）
                             • 异常处理
发送事件 ─────────────────>  
"arrived at zone_A"          基于状态响应：
                             • 触发异物检测
<──────────────────── 返回结果 • 计算运动指令
(异物列表, 运动指令)          • 记录日志
```

---

### 决策2：位姿管理 - 预定义位姿 + 无实时上报
**决策：** PLC只发送"到位信号"，不实时上报机械臂位姿；ROS 2基于预定义位姿配置工作

**理由：**
- 简化通信：无需高频位姿数据流
- 符合IBVS原理：基于图像反馈，不依赖绝对位姿
- 降低延迟敏感度：事件驱动而非数据同步

**实现方式：**
```yaml
# config/workspace.yaml - 预定义所有工作位姿
predefined_poses:
  vision_arm:
    tray_scan: [x, y, z, roll, pitch, yaw]
    zone_A: [x, y, z, roll, pitch, yaw]
    zone_B: [x, y, z, roll, pitch, yaw]
    # ... 20-30个区域位姿
  gripper_arm:
    home: [...]
    wash_station: [...]
  pressure_arm:
    # ... 各区域压板位姿
```

**工作流程：**
1. PLC移动视觉臂到zone_A → 发送"arrived at zone_A"
2. ROS 2知道相机在预定义的zone_A位姿
3. ROS 2基于此位姿进行坐标转换和识别

---

### 决策3：IBVS伺服 - 纯图像反馈闭环
**决策：** IBVS完全基于图像误差，发送增量位姿指令给PLC

**理由：**

- 无需3D位姿反馈，降低系统复杂度
- ViSP成熟方案，经典IBVS算法
- 适合高精度对准（几十微米级别异物）

**控制流程：**
```
循环执行（10-20Hz）：
1. 拍照
2. 检测图像中：
   - 异物特征点位置 (u_target, v_target)
   - 夹爪标记位置 (u_gripper, v_gripper)
3. 计算图像误差：Δu, Δv
4. ViSP计算运动指令：Δx, Δy, Δz
5. 发送增量位姿给PLC
6. 判断收敛：|Δu| < 5 pixels → 返回"到达"
```

**夹爪标记识别：**
- 在夹爪后部设置醒目标记（易识别）
- 视觉识别标记位置 → 反推夹爪头部位置
- 避免直接识别夹爪头部（减轻计算压力）

---

### 决策4：初期不使用MoveIt
**决策：** 初期直接运动控制，不引入MoveIt轨迹规划

**理由：**
- 三角形布局 + 固定工作区域，基本无碰撞风险
- 预定义路径，运动模式固定
- MoveIt规划耗时（几百ms），影响节拍时间
- 先跑通主流程，避免过早优化

**扩展性预留：**
- 架构中保留"运动计算"模块接口
- 后期如需碰撞检测，可插入MoveIt规划服务
- 配置切换：`planning_mode: simple / moveit`

---

### 决策5：响应式状态管理
**决策：** ROS 2维护状态机，响应式编程，而非命令式

**理由：**
- PLC发送事件（arrived, error等），ROS 2基于当前状态响应
- 灵活应对异常情况，易于扩展
- 符合ROS 2的异步编程范式

**状态示例：**
```
IDLE → LOCATING_TRAY → DETECTING_OBJECTS → IBVS_SERVOING → 
GRIPPER_CLOSING → CLEANING → VERIFYING → (下一区域 or 完成)
                              ↓
                         ERROR_RECOVERY
```

---

## 3. 技术栈选择

### 3.1 核心技术
| 组件 | 技术选型 | 说明 |
|------|---------|------|
| 机器人框架 | **ROS 2 Humble** | 长期支持版本，Ubuntu 22.04 |
| 视觉伺服 | **ViSP** | 成熟的IBVS库 |
| 深度学习推理 | **TensorRT** | GPU加速，低延迟 |
| 图像处理 | **OpenCV** | 边缘检测（托盘定位）|
| PLC通信 | **PROFINET** | 机械臂标准协议 |
| 坐标转换 | **tf2** | ROS 2标准TF库 |
| 状态机 | **内置状态机** | ROS 2节点实现（暂不用BehaviorTree）|

### 3.2 开发环境
- **操作系统：** Ubuntu 22.04 LTS
- **编程语言：** C++（核心节点）、Python（工具脚本）
- **相机接口：** USB 3.0 / GigE
- **目标硬件：** PC工控机 + PLC + 三台机械臂

---

## 4. 系统分层架构

### 4.1 整体分层
```
┌─────────────────────────────────────────┐
│  业务逻辑层 (Application Layer)         │
│  • 托盘定位服务                          │
│  • 异物识别服务                          │
│  • 视觉伺服夹取服务                      │
└─────────────────────────────────────────┘
                  ↓ 调用
┌─────────────────────────────────────────┐
│  Core层 (Capability Layer)              │
│  ├─ 视觉处理（深度学习、图像算法）      │
│  ├─ 运动计算（TF转换、IBVS）            │
│  └─ 状态管理（状态模式、异常处理）      │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  硬件接口层 (Hardware Interface)        │
│  ├─ PLC通信接口                         │
│  └─ 相机驱动（USB/GigE）                │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  硬件层 (Physical)                      │
│  ├─ PLC + 三台机械臂                    │
│  └─ 工业相机                            │
└─────────────────────────────────────────┘

横向支撑：
• 配置管理 (config/)：预定义位姿、手眼标定、模型配置
• 数据管理 (data/)：日志记录、异常保存、性能监控
```

### 4.2 ROS 2在PC端的职责
- ✅ 视觉智能（AI推理、图像处理）
- ✅ 运动计算（坐标转换、IBVS算法）
- ✅ 状态管理（响应式状态机）
- ✅ 数据记录（日志、异常、统计）
- ❌ 不做：底层运动控制、三臂协调

### 4.3 PLC的职责（外部系统）
- 三臂协同状态机（主流程）
- 机械臂实时运动控制
- 到位检测、安全保护
- 调用ROS 2服务获取智能结果

---

## 5. 关键设计点

### 5.1 坐标系管理
**TF树结构（最小化）：**
```
world (全局坐标系)
  └─ camera_optical_frame (动态发布，基于当前预定义位姿)
      └─ tray_frame (托盘定位后固定发布)
```

**手眼标定：**
- 离线标定一次（使用ArUco Marker或边缘标定）
- 生成`config/hand_eye.yaml`
- 启动时加载标定参数，应用于TF变换

**托盘定位：**
- 视觉臂扫描托盘边缘（在预定义扫描位姿）
- 边缘拟合计算托盘在world中的位姿
- 发布并维护`world → tray_frame`变换
- 所有异物位置相对tray_frame表示

### 5.2 异物检测流程
1. 压板臂压住区域 → 视觉臂移动到区域上方
2. PLC发送"arrived at zone_A"
3. ROS 2：
   - 静止拍照一张
   - 深度学习推理（检测所有异物）
   - 坐标转换（camera → world）
   - 返回第一个异物位置给PLC，让已经粗定位过来的夹取机械臂开始移动到第一个异物位置
   - 夹取结束之后再给PLC第二个异物位置让其移动过来夹取第二个异物

### 5.3 IBVS夹取流程
1. PLC粗定位夹爪到异物附近
2. PLC发送移动到位信号，此时开始视觉伺服引导机械臂继续靠近
3. ROS 2循环执行（10-20Hz）：
   - 连续拍照
   - 检测异物和夹爪标记在图像中的位置
   - ViSP计算增量位姿
   - 发送增量指令给PLC
   - 判断收敛（图像误差 < 阈值）
4. 收敛后返回"到达"信号
5. PLC执行夹取动作

### 5.4 异常处理策略
| 异常类型 | 处理策略 |
|---------|---------|
| 夹取失败 | 重试3次，失败则记录并跳过 |
| 视觉服务超时 | 自动重启节点，失败则跳过当前区域 |
| PLC通信中断 | 尝试重连3秒，失败则紧急停止 |
| IBVS不收敛 | 超时后放弃，记录失败日志 |
| 相机断开 | 自动重启驱动，失败则报警 |

---

## 6. 数据流向

### 6.1 典型工作循环数据流
```
1. PLC → ROS 2: Event "vision_arm_arrived at zone_A"
2. ROS 2: 
   - 拍照 → 深度学习推理 → 检测到3个异物
   - 坐标转换：camera → world
   - 保存异物列表在内部状态
3. ROS 2 → PLC: Message "第1个异物位置: object1_pose"
4. PLC: 夹取臂粗定位移动到object1附近
5. PLC → ROS 2: Event "gripper_arm_arrived at object1"
6. ROS 2: 自动启动IBVS伺服循环（10-20Hz）
   - 连续拍照 → 检测异物和夹爪标记
   - 计算图像误差 → ViSP计算增量位姿
   - 发送增量指令: Topic "/motion/gripper_command"
7. PLC: 实时执行增量运动
8. ROS 2: 判断IBVS收敛（图像误差 < 阈值）
9. ROS 2 → PLC: Event "ibvs_converged" (到达)
10. PLC: 执行夹取 → 移动到清洗位 → 清洗 → 返回到区域上方
11. PLC → ROS 2: Event "grasp_completed"
12. ROS 2 → PLC: Message "第2个异物位置: object2_pose"
13. 重复步骤4-12，直到所有异物处理完
14. ROS 2 → PLC: Message "zone_A_completed, no_more_objects"
15. PLC: 移动到下一区域 zone_B
```

**关键点：**
- ✅ **逐个返回异物**：不是一次性返回列表，而是处理完一个再给下一个
- ✅ **到位自动触发IBVS**：PLC发送到位信号后，ROS 2自动开始伺服，无需再次调用服务
- ✅ **状态驱动**：ROS 2维护当前处理到第几个异物，响应式推进流程
- ✅ **异步通信**：IBVS期间PLC持续执行运动，ROS 2持续发送指令

---

## 7. 配置管理

### 7.1 配置文件结构
```
config/
├── workspace.yaml          # 预定义位姿（20-30个区域）
├── hand_eye.yaml           # 手眼标定参数
├── camera.yaml             # 相机内参、曝光参数
├── vision.yaml             # 深度学习模型路径、置信度阈值
├── ibvs.yaml               # IBVS收敛阈值、控制参数
└── system.yaml             # 系统参数（重试次数、超时时间）
```

---

## 8. 待细化部分（后续设计TODO）

### 8.1 ROS 2节点设计
- [ ] 节点拆分粒度（几个节点？各自职责？）
- [ ] 节点间通信模式（Topic/Service/Action选择）
- [ ] 节点命名规范
- [ ] Launch文件结构

### 8.2 接口定义
- [ ] 服务接口详细定义（.srv文件）
  - DetectObjects.srv
  - LocateTray.srv
  - IbvsGrasp.srv
- [ ] 消息类型定义（.msg文件）
  - ForeignObject.msg
  - TrayPose.msg
  - ArmStatus.msg
- [ ] PLC通信协议详细规范（单独文档）

### 8.3 状态机实现
- [ ] 状态定义和转换图
- [ ] 状态机代码实现方案（C++类设计）
- [ ] 事件处理机制

### 8.4 深度学习模型
- [ ] 模型选择（YOLO / EfficientDet / 自定义）
- [ ] 训练数据准备
- [ ] TensorRT优化流程
- [ ] 模型部署方案

### 8.5 IBVS详细设计
- [ ] ViSP集成方案
- [ ] 夹爪标记设计和检测算法
- [ ] 收敛判据细化
- [ ] 失败恢复策略

### 8.6 测试策略
- [ ] 单元测试范围
- [ ] 集成测试方案
- [ ] 视觉模拟测试（无硬件）
- [ ] 性能基准测试

### 8.7 部署和运维
- [ ] Docker容器化
- [ ] 日志分级和管理
- [ ] 性能监控指标
- [ ] 故障诊断工具

---

## 9. 开发优先级（初步）

### Phase 1: 基础框架（1-2周）
- ROS 2节点框架搭建
- 相机驱动集成
- 基础TF管理
- 配置文件加载

### Phase 2: 视觉处理（2-3周）
- 深度学习模型训练
- TensorRT推理集成
- 托盘定位算法
- 异物检测服务

### Phase 3: 运动控制（2-3周）
- 手眼标定工具
- 坐标转换实现
- IBVS伺服实现
- PLC通信接口（mock测试）

### Phase 4: 状态管理（1-2周）
- 状态机实现
- 异常处理逻辑
- 日志和监控

### Phase 5: 集成测试（2-3周）
- PLC联调
- 完整流程测试
- 性能优化
- 稳定性测试

---

## 10. 风险和限制

### 10.1 技术风险
| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| IBVS收敛速度慢 | 影响节拍时间 | 调优ViSP参数，必要时改用混合控制 |
| 深度学习识别率不足 | 漏检异物 | 多轮数据增强，调整阈值 |
| PLC通信延迟高 | IBVS抖动 | 优化通信频率，缓存机制 |
| 托盘位置偏差大 | 边缘检测失败 | 增加机械约束，多次测量平均 |

### 10.2 当前限制
- 初期不支持嵌入式异物检测（只检测表面）
- 不支持异物分类（毛发、黑点统一处理）
- 夹取成功率依赖夹爪设计（未验证）
- 水面反光影响需后续实验确认

---

## 11. 参考资料

### 11.1 技术文档
- ROS 2 Humble Documentation
- ViSP Tutorial: https://visp.inria.fr/
- TensorRT Developer Guide
- OpenCV Documentation

### 11.2 相关项目参考
- （待补充：类似视觉伺服项目）

### 11.3 内部文档
- `docs/requirement.md` - 详细需求文档
- `docs/workflow-diagrams-noMoveIt.md` - 工作流程图
- `docs/PLC-comunicate.md` - PLC通信协议（待完善）

---

## 附录：架构图文字描述

```
┌─────────────────────────────────────────────────────────────┐
│                    ROS 2 Core层                              │
│  ┌────────────┬────────────────┬────────────────────────┐  │
│  │ 视觉处理   │  运动计算       │   状态管理             │  │
│  │ • 深度学习 │ • 坐标系转换    │ • 状态模式             │  │
│  │ • 图像处理 │ • IBVS伺服      │ • 异常处理             │  │
│  └────────────┴────────────────┴────────────────────────┘  │
│                 ROS机器人操作系统 (TF、日志等)               │
└─────────────────────────────────────────────────────────────┘
                          ↕ 调用
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层                                │
│  ┌──────────────┬──────────────────┬──────────────────┐    │
│  │ 托盘定位     │ 异物识别         │ 视觉伺服夹取     │    │
│  └──────────────┴──────────────────┴──────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                          ↕ 
            相机图像、物体坐标、到位反馈
                          ↕
┌─────────────────────────────────────────────────────────────┐
│                    硬件接口层                                │
│  ┌──────────────────┬─────────────────────────────────┐    │
│  │ 相机驱动         │  PLC通信接口                     │    │
│  │ (USB/GigE)       │  (压板臂、视觉臂、夹取臂、夹爪)  │    │
│  └──────────────────┴─────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘

横向支撑：
├─ config配置: 预定义位姿、手眼标定、模型配置
└─ 数据管理: 日志记录、异常保存、性能监控
```

---

**文档状态：** ✅ 架构决策已确定，待后续详细设计
**下一步：** ROS 2节点详细设计（参考Section 8.1）

